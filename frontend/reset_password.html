<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Codavatar InternTrack - Reset Password</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="brand">
        <div>
          <h1>Reset Password</h1>
          <small>Set a new strong password</small>
        </div>
        <button class="toggle" onclick="toggleTheme()">üåô/‚òÄÔ∏è Theme</button>
      </div>

      <div id="msg" class="msg"></div>

      <form id="form" class="form">
        <div class="field">
          <label>Token</label>
          <input id="token" type="text" readonly />
          <div class="help">Token is auto-filled from your email link.</div>
        </div>

        <div class="field">
          <label for="password">New Password</label>
          <div class="input-row">
            <input id="password" type="password" placeholder="Min 8, Uppercase, Number, Special" required />
            <button class="eye-btn" type="button" id="pwToggleBtn">Show</button>
          </div>
          <div id="meter" class="pw-meter" style="margin-top:8px">
            <span id="m_len">8+ chars</span>
            <span id="m_upper">Uppercase</span>
            <span id="m_num">Number</span>
            <span id="m_special">Special</span>
          </div>
        </div>

        <div class="field">
          <label for="password2">Retype New Password</label>
          <div class="input-row">
            <input id="password2" type="password" placeholder="Retype password" required />
            <button class="eye-btn" type="button" id="pw2ToggleBtn">Show</button>
          </div>
        </div>

        <button id="resetBtn" class="btn" type="button">Reset password</button>

        <div class="footer">
          <a class="small-link" href="login.html">Back to login</a>
        </div>
      </form>
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/auth.js"></script>
  <script>
    initTheme();
    togglePassword("password", "pwToggleBtn");
    togglePassword("password2", "pw2ToggleBtn");

    const msg = document.getElementById("msg");
    const form = document.getElementById("form");
    const resetBtn = document.getElementById("resetBtn");

    const pw = document.getElementById("password");
    const pw2 = document.getElementById("password2");

    const mLen = document.getElementById("m_len");
    const mUpper = document.getElementById("m_upper");
    const mNum = document.getElementById("m_num");
    const mSpecial = document.getElementById("m_special");

    function updateMeter() {
      const c = passwordChecks(pw.value || "");
      mLen.className = c.len ? "good" : "bad";
      mUpper.className = c.upper ? "good" : "bad";
      mNum.className = c.num ? "good" : "bad";
      mSpecial.className = c.special ? "good" : "bad";
    }
    pw.addEventListener("input", updateMeter);
    updateMeter();

    function getQueryParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // auto fill token from email link
    const token = getQueryParam("token");
    document.getElementById("token").value = token || "";

    bindEnterToSubmit(form, resetBtn);

    async function doReset() {
      hideMsg(msg);
      resetBtn.disabled = true;

      const tokenVal = document.getElementById("token").value.trim();
      const new_password = pw.value;
      const new_password2 = pw2.value;

      if (!tokenVal) {
        showMsg(msg, "Reset token missing. Open the reset link from email.", "err");
        resetBtn.disabled = false;
        return;
      }

      if (!passwordStrong(new_password)) {
        showMsg(msg, "Password must be 8+ chars and include uppercase, number, and special character.", "err");
        resetBtn.disabled = false;
        return;
      }
      if (new_password !== new_password2) {
        showMsg(msg, "Passwords do not match.", "err");
        resetBtn.disabled = false;
        return;
      }

      try {
        const res = await apiFetch("/accounts/reset-password/", {
          method: "POST",
          body: JSON.stringify({ token: tokenVal, new_password })
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          showMsg(msg, data.detail || "Reset failed", "err");
          resetBtn.disabled = false;
          return;
        }

        showMsg(msg, data.detail || "Password reset successful. You can login now.", "ok");
        form.reset();
        document.getElementById("token").value = tokenVal; // keep token visible
        updateMeter();

        // redirect to login after success (small delay)
        setTimeout(() => window.location.href = "login.html", 1200);
      } catch (e) {
        showMsg(msg, "Network error. Is backend running?", "err");
      } finally {
        resetBtn.disabled = false;
      }
    }

    resetBtn.addEventListener("click", doReset);
  </script>
</body>
</html>
